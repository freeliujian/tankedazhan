<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tankedazhan</title>
    <style>
      /* #box{
        width: 500px;
        height: 900px;
        background: pink;
      } */
    </style>
  </head>

  <body>
    <div id="box"></div>
    <div id="zuobiao">0,0</div>
    <script src="./js/pixi.js"></script>
    <!-- <script src="./js/map.js"></script> -->
    <script>
      // 获取坐标
      document.getElementById("box").onmousemove = (e) => {
        const zuobiao = {
          x: event.clientX - event.target.offsetLeft,
          y: event.clientY - event.target.offsetTop,
        };
        document.getElementById(
          "zuobiao"
        ).innerHTML = `${zuobiao.x},${zuobiao.y}`;
      };

      const stage = {
        stage1:[
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0, 1,1, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        ]
        // stage1:[
        //   [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        //   [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,1,1,3,3,1,1,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,1,1,3,3,1,1,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0],
        //   [0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0],
        //   [1,1,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,1,1],
        //   [3,3,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,3,3],
        //   [0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0],
        //   [0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0],
        //   [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        //   [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        // ]
      }
      
      const materials = {
        wall: 1,
        grass: 2,
        steel: 3,
        river: 4,
      };
      const constants = {
        animations: {
          INIT_TANK_DOWN: "init-tank-down",
          INIT_TANK_RIGHT: "init-tank-right",
          INIT_TANK_LEFT: "init-tank-left",
          INIT_TANK_UP: "init-tank-up",
          LEVEL2_TANK_DOWN: "level2-tank-down",
          LEVEL2_TANK_UP: "level2-tank-up",
          LEVEL2_TANK_LEFT: "level2-tank-left",
          LEVEL2_TANK_RIGHT: "level2-tank-right",
          LEVEL3_TANK_DOWN: "level3-tank-down",
          LEVEL3_TANK_UP: "level3-tank-up",
          LEVEL3_TANK_LEFT: "level3-tank-left",
          LEVEL3_TANK_RIGHT: "level3-tank-right",
          LEVEL4_TANK_DOWN: "level4-tank-down",
          LEVEL4_TANK_UP: "level4-tank-up",
          LEVEL4_TANK_LEFT: "level4-tank-left",
          LEVEL4_TANK_RIGHT: "level4-tank-right",
          BOOM: "baozha",
          BIRTH: "chusheng",
          WUDI: "wudi",
        },
        type: {
          BIRTH_CONTAINER: "birthContainer",
        },
        texture: {
          materials: {
            ZHUANGBEI_FENSHU: "zhuangbei-fenshu.png",
            ZHUANGBEI_HOUQIANG: "zhuangbei-houqiang.png",
            ZHUANGBEI_SHENGJI: "zhuangbei-shengji.png",
            ZHUANGBEI_SHIJIANZANTING: "zhuangbei-shijianzanting.png",
            ZHUANGBEI_SHOUQIANG: "zhuangbei-shouqiang.png",
            ZHUANGBEI_TOUKUI: "zhuangbei-toukui.png",
            ZHUANGBEI_ZHADAN: "zhuangbei-zhadan.png",
          },
        },
      };

      const scale = {
        X: 2,
        Y: 2,
      };

      const defaultSpeed = {
        vx: 0,
        vy: 0,
      };

      function hitTestRectangle(r1, r2) {
        let hit, combinedHalfWidths, combinedHalfHeights, vx, vy;

        hit = false;
        r1.centerX = r1.x + r1.width / 2;
        r1.centerY = r1.y + r1.height / 2;
        r2.centerX = r2.x + r2.width / 2;
        r2.centerY = r2.y + r2.height / 2;

        r1.halfWidth = r1.width / 2;
        r1.halfHeight = r1.height / 2;
        r2.halfWidth = r2.width / 2;
        r2.halfHeight = r2.height / 2;

        vx = r1.centerX - r2.centerX;
        vy = r1.centerY - r2.centerY;

        combinedHalfWidths = r1.halfWidth + r2.halfWidth;
        combinedHalfHeights = r1.halfHeight + r2.halfHeight;

        if (Math.abs(vx) < combinedHalfWidths) {
          if (Math.abs(vy) < combinedHalfHeights) {
            hit = true;
          } else {
            hit = false;
          }
        } else {
          hit = false;
        }

        return hit;
      }

      function keyboard(value) {
        let key = {};
        key.value = value;
        key.isDown = false;
        key.isUp = true;
        key.press = undefined;
        key.release = undefined;
        //The `downHandler`
        key.downHandler = (event) => {
          if (event.key === key.value) {
            if (key.isUp && key.press) key.press();
            key.isDown = true;
            key.isUp = false;
            event.preventDefault();
          }
        };

        //The `upHandler`
        key.upHandler = (event) => {
          if (event.key === key.value) {
            if (key.isDown && key.release) key.release();
            key.isDown = false;
            key.isUp = true;
            event.preventDefault();
          }
        };

        //Attach event listeners
        const downListener = key.downHandler.bind(key);
        const upListener = key.upHandler.bind(key);

        window.addEventListener("keydown", downListener, false);
        window.addEventListener("keyup", upListener, false);

        // Detach event listeners
        key.unsubscribe = () => {
          window.removeEventListener("keydown", downListener);
          window.removeEventListener("keyup", upListener);
        };

        return key;
      }

      function TankWar({ width, height, element }) {
        this.width = width;
        this.height = height;
        this.element = element;
        this.loader = null;
        this.player = null;
        this.wudiSprite = null;
        this.zhuangbeiContainer = null;
        this.badTankContainer = null;
        this.mapContainer = null;
        this.application = null;
        this.gun = null;
        this.panelContainer = null;
        this.wallArr = null;
        //目前关卡，为0为未开始
        this.currentStage = 1;
        this.status = {
          init: 0,
          padding: 1,
          paddingEnd: 2,
        };
        this.direction = {
          upIsDown: true,
          leftIsDown: true,
          downIsDown: false,
          rightIsDown: true,
        };
        this.life = 1;
        this.score = 0;
       
        this.init();
      }

      TankWar.prototype.init = function () {
        const { width, height, element } = this;

        this.application = new PIXI.Application({ width, height });
        const dom = document.getElementById(element);
        dom.appendChild(this.application.view);
        this.render();
      };

      TankWar.prototype.play = function (delta) {
        const { gun, wallArr, removeGun, zhuangbeiContainer } = this;
        const { children } = gun;
        const { leftWall, rightWall, topWall, bottomWall } = wallArr;

        const zhuangbeiName = constants.texture.materials;
        const mapContainerArr = this.mapContainer.children
   
        const score = zhuangbeiContainer.getChildByName(
          zhuangbeiName.ZHUANGBEI_FENSHU
        );
        const addWall = zhuangbeiContainer.getChildByName(
          zhuangbeiName.ZHUANGBEI_HOUQIANG
        );
        const addLevel = zhuangbeiContainer.getChildByName(
          zhuangbeiName.ZHUANGBEI_SHENGJI
        );
        const timeStop = zhuangbeiContainer.getChildByName(
          zhuangbeiName.ZHUANGBEI_SHIJIANZANTING
        );
        const handGun = zhuangbeiContainer.getChildByName(
          zhuangbeiName.ZHUANGBEI_SHOUQIANG
        );
        const invincible = zhuangbeiContainer.getChildByName(
          zhuangbeiName.ZHUANGBEI_TOUKUI
        );
        const allBoom = zhuangbeiContainer.getChildByName(
          zhuangbeiName.ZHUANGBEI_ZHADAN
        );

        //是否发射子弹
        if (children.length !== 0) {
          const getGun = gun.getChildAt(0);
          const wallChildren = this.wallArr.wall.children;
          getGun.x += getGun.vx;
          getGun.y += getGun.vy;
          for(let i =0;i<wallChildren.length;i++){
            if (hitTestRectangle(getGun, wallChildren[i])) {
              this.removeGun();
            }
          };

          for(let i = 0; i < mapContainerArr.length;i++){
            if(hitTestRectangle(getGun,mapContainerArr[i])){
              // console.log(mapContainerArr[i].x,mapContainerArr[i].y, getGun.x,getGun.y);
              this.removeWall(mapContainerArr[i]);
            }
          }
        };

        if (this.zhuangbeiContainer && this.player && score) {
          if (hitTestRectangle(this.player, score) && score.visible) {
            console.log("加十分");
            this.score += 10;
            score.visible = false;
          }
          if (hitTestRectangle(this.player, addWall) && addWall.visible) {
            console.log("总部加墙壁");
            addWall.visible = false;
          }
          if (hitTestRectangle(this.player, addLevel) && addLevel.visible) {
            if (this.left < 3) {
              this.life += 1;
            } else {
              this.score += 10;
            }
            addLevel.visible = false;
          }
          if (hitTestRectangle(this.player, timeStop) && timeStop.visible) {
            console.log("时间暂停");
            timeStop.visible = false;
          }
          if (hitTestRectangle(this.player, handGun) && handGun.visible) {
            console.log("升满级");
            this.life = 3;
            handGun.visible = false;
          }
          if (hitTestRectangle(this.player, invincible) && invincible.visible) {
            console.log("无敌");
            this.life = 100;
            invincible.visible = false;
          }
          if (hitTestRectangle(this.player, allBoom) && allBoom.visible) {
            console.log("全部炸死");
            allBoom.visible = false;
          }
        }

        if (!!this.player) {
          this.player.x += this.player.vx;
          this.player.y += this.player.vy;
        }

        if (!!this.wudiSprite) {
          this.wudiSprite.x += this.player.vx;
          this.wudiSprite.y += this.player.vy;
        }
      };

      TankWar.prototype.settingSpriteAttribute = function(sprite,x,y) {
        sprite.position.set( x ,y);
        sprite.scale.set(2,2);
        sprite.anchor.set(0.5,0.5);
        return sprite;
      }

      TankWar.prototype.tankDirection = function (dir) {
        const playerDir = this.player.children;
        for (let i = 0; i < playerDir.length; i++) {
          if (playerDir[i].name === dir) {
            playerDir[i].visible = true;
          } else {
            playerDir[i].visible = false;
          }
        }
      };

      TankWar.prototype.handle = function () {
        let left = keyboard("ArrowLeft"),
          up = keyboard("ArrowUp"),
          right = keyboard("ArrowRight"),
          down = keyboard("ArrowDown");
        keyz = keyboard("z");

        keyz.press = () => {
          this.fire();
        };

        keyz.release = () => {
          console.log("reslease");
        };

        left.press = () => {
          this.player.vx = -1;
          this.player.vy = 0;
          this.tankDirection(constants.animations.INIT_TANK_LEFT);
        };

        left.release = () => {
          if (!right.isDown && this.player.vy === 0) {
            this.player.vx = 0;
            this.direction = {
              upIsDown: true,
              leftIsDown: true,
              rightIsDown: right.isDown,
              downIsDown: true,
            };
          }
        };

        up.press = () => {
          this.player.vy = -1;
          this.player.vx = 0;
          this.tankDirection(constants.animations.INIT_TANK_UP);
        };
        up.release = () => {
          if (!down.isDown && this.player.vx === 0) {
            this.player.vy = 0;
            this.direction = {
              upIsDown: true,
              leftIsDown: true,
              rightIsDown: true,
              downIsDown: down.isDown,
            };
          }
        };

        right.press = () => {
          this.player.vx = 1;
          this.player.vy = 0;
          this.tankDirection(constants.animations.INIT_TANK_RIGHT);
        };
        right.release = () => {
          if (!left.isDown && this.player.vy === 0) {
            this.player.vx = 0;
            this.direction = {
              upIsDown: true,
              leftIsDown: left.isDown,
              rightIsDown: true,
              downIsDown: true,
            };
          }
        };

        down.press = () => {
          this.player.vy = 1;
          this.player.vx = 0;
          this.tankDirection(constants.animations.INIT_TANK_DOWN);
        };
        down.release = () => {
          if (!up.isDown && this.player.vx === 0) {
            this.player.vy = 0;
            this.direction = {
              upIsDown: up.isDown,
              leftIsDown: true,
              rightIsDown: true,
              downIsDown: true,
            };
          }
        };
      };

      TankWar.prototype.birth = function (id) {
        const { BIRTH, BIRTH_CONTAINER } = constants.animations;
        const birthContainer = new PIXI.Container();
        const initPosition = {
          x: this.width / 2 - 150,
          y: this.height - 25,
        };
        birthContainer.name = BIRTH_CONTAINER;
        for (let i = 0; i < 4; i++) {
          const birthAnimation = new PIXI.AnimatedSprite(id.animations[BIRTH]);
          birthAnimation.name = `birthAnimation-${i}`;
          // if (i === 0) {
          //   birthAnimation.position.set(20, 20);
          // }
          // if (i === 1) {
          //   birthAnimation.position.set(this.width / 2 - 80, 20);
          // }
          // if (i === 2) {
          //   birthAnimation.position.set(this.width - 160, 20);
          // }
          if (i === 3) {
            birthAnimation.position.set(initPosition.x, initPosition.y);
          } 
          birthAnimation.anchor.set(0.5, 0.5);
          birthAnimation.scale.set(1.2, 1.2);
          birthAnimation.visible = false;
          birthAnimation.animationSpeed = 0.1;
          birthAnimation.play();
          birthContainer.addChild(birthAnimation);
        }
        this.application.stage.addChild(birthContainer);
        birthContainer.getChildByName("birthAnimation-3");
        birthContainer.getChildByName("birthAnimation-3").visible = true;
        setTimeout(() => {
          birthContainer.getChildByName("birthAnimation-3").visible = false;
          this.wudi(id.animations, initPosition);
          this.createdPlayer(id.animations, initPosition);
        }, 2000);
      };

      TankWar.prototype.wudi = function (animationPosition, initPosition) {
        const { x, y } = initPosition;
        this.wudiSprite = new PIXI.AnimatedSprite(
          animationPosition[constants.animations.WUDI]
        );
        this.wudiSprite.position.set(x, y);
        this.wudiSprite.scale.set(2, 2);
        this.wudiSprite.anchor.set(0.5, 0.5);
        this.wudiSprite.animationSpeed = 0.15;
        this.wudiSprite.play();
        this.application.stage.addChild(this.wudiSprite);
      };

      TankWar.prototype.createdPlayer = function (
        animationPosition,
        initPosition
      ) {
        const { x, y } = initPosition;
        const { vx, vy } = defaultSpeed;
        this.player = new PIXI.Container();
        Object.keys(constants.animations).forEach((item, index) => {
          let tankDir = new PIXI.AnimatedSprite(
            animationPosition[constants.animations[item]]
          );
          tankDir.animationSpeed = 0.2;
          tankDir.anchor.set(0.5, 0.5);
          tankDir.play();
          tankDir.visible =
            constants.animations[item] === constants.animations.INIT_TANK_UP;
          tankDir.name = constants.animations[item];
          this.player.addChild(tankDir);
        });
        this.player.life = this.life;
        this.player.scale.x = scale.X;
        this.player.scale.y = scale.Y;
        this.player.vx = vx;
        this.player.vy = vy;
        this.player.position.set(x, y);
        this.application.stage.addChild(this.player);
      };

      TankWar.prototype.render = function () {
        const { INIT_TANK_DOWN } = constants.animations;
        const that = this;
        that.loader = new PIXI.Loader();
        that.loader
          .add("tank", "./tankedazhan.png")
          .add("spaceship", "tankedazhan.json");
        that.loader.load((loader, resource) => {
          const id = resource.spaceship.spritesheet;
          this.createMap(id);
          this.panel(id);
          this.birth(id);
          this.materials(id);
          this.application.ticker.add(function (delta) {
            that.play(delta);
          });
          this.gun = new PIXI.Container();
          this.application.stage.addChild(this.gun);
          this.handle();
          this.createAirWall();
        });
      };

      TankWar.prototype.createAirWall = function () {
        const wall = new PIXI.Container();
        this.application.stage.addChild(wall);

        const leftWall = new PIXI.Graphics();
        leftWall.beginFill(0xcccccc);
        leftWall.drawRect(0, 0, 5, this.height);
        leftWall.position.set(0, 0);
        leftWall.endFill();
        wall.addChild(leftWall);

        const rightWall = new PIXI.Graphics();
        rightWall.beginFill(0xcccccc);
        rightWall.drawRect(0, 0, 5, this.height);
        rightWall.endFill();
        rightWall.position.set(this.width - 145, 0);
        wall.addChild(rightWall);

        const topWall = new PIXI.Graphics();
        topWall.beginFill(0xcccccc);
        topWall.drawRect(0, 0, this.width, 5);
        topWall.position.set(0, 0);
        topWall.endFill();
        wall.addChild(topWall);

        const bottomWall = new PIXI.Graphics();
        bottomWall.beginFill(0xcccccc);
        bottomWall.drawRect(0, 0, this.width, 5);
        bottomWall.position.set(0, this.height - 5);
        bottomWall.endFill();

        this.wallArr = {
          wall: wall,
          leftWall: leftWall,
          rightWall: rightWall,
          topWall: topWall,
          bottomWall: bottomWall,
        };

        wall.addChild(bottomWall);
      };

      TankWar.prototype.fire = function () {
        const { upIsDown, leftIsDown, downIsDown, rightIsDown } =
          this.direction;
        const { vx, vy } = defaultSpeed;
        const { x, y, width, height } = this.player;
        const gunX = x + width;
        const gunY = y + height;
        if (this.gun.children.length === 0 && this.gun.children < 2) {
          const gun = new PIXI.Graphics();
          gun.beginFill(0xffffff);
          gun.drawRect(0, 0, 5, 5);
          gun.endFill();
          this.gun.addChild(gun);
          if (!upIsDown) {
            gun.vx = 0;
            gun.vy = 4;
            gun.x = gunX - width - 2;
            gun.y = gunY - height + 10;
          } else if (!leftIsDown) {
            gun.vx = 3;
            gun.vy = 0;
            gun.x = gunX - width + 11;
            gun.y = gunY - height - 3;
          } else if (!rightIsDown) {
            gun.vx = -3;
            gun.vy = 0;
            gun.x = gunX - width - 20;
            gun.y = gunY - height - 4;
          } else if (!downIsDown) {
            gun.vx = 0;
            gun.vy = -4;
            gun.x = gunX - width - 2;
            gun.y = gunY - height - 13;
          }
        }
      };

      TankWar.prototype.removeGun = function () {
        const { gun } = this;
        const getGun = gun.getChildAt(0);
        gun.removeChildren();
        this.boom(getGun.x, getGun.y);
      };

      TankWar.prototype.removeWall = function (wall) {
        this.removeGun();
        this.mapContainer.removeChild(wall);
        console.log(wall)
      }

      TankWar.prototype.boom = function (x, y) {
        const { BOOM } = constants.animations;
        const id = this.loader.resources.spaceship.spritesheet.animations;
        const boom = new PIXI.AnimatedSprite(id[BOOM]);
        boom.animationSpeed = 0.2;
        boom.play();
        boom.name = BOOM;
        boom.loop = false;
        boom.onComplete = () => {
          const getBOOM = this.application.stage.getChildByName(BOOM);
          this.application.stage.removeChild(getBOOM);
        };
        boom.scale.x = 2;
        boom.scale.y = 2;
        boom.anchor.set(0.5, 0.5);
        boom.x = x;
        boom.y = y;
        this.application.stage.addChild(boom);
      };

      TankWar.prototype.createMap = function () {
        //..
      };

      TankWar.prototype.badTank = function () {
        this.badTankContainer = new PIXI.Container();
      };

      TankWar.prototype.panel = function (id) {
        this.panelContainer = new PIXI.Container();
        const graphics = new PIXI.Graphics();
        graphics.beginFill(0xcccccc);
        graphics.drawRect(0, 0, 140, this.height);
        graphics.endFill();
        graphics.zIndex = 1;
        this.panelContainer.position.set(this.width - 140, 0);
        this.panelContainer.addChild(graphics);
        //地方坦克计分板
        const badTankLift = new PIXI.ParticleContainer();
        badTankLift.position.set(20, 20);
        for (let i = 0; i < 20; i++) {
          const badLift = new PIXI.Sprite(
            id.textures["jifenban-difangtank.png"]
          );
          badLift.scale.set(2, 2);
          if (i % 2 === 0) {
            badLift.position.set(0, 10 * i);
          } else {
            badLift.position.set(20, 10 * i);
          }

          badTankLift.addChild(badLift);
        }

        //玩家坦克剩余命数
        const playerHealth = new PIXI.ParticleContainer();
        playerHealth.position.set(20, 300);
        const labelIcon = new PIXI.Sprite(id.textures["home-2.png"]);
        for (let i = 0; i < 3; i++) {
          const Health = new PIXI.Sprite(id.textures["jifenban-title.png"]);
          Health.scale.set(2, 2);

          Health.position.set(17 * i, 40);
          playerHealth.addChild(Health);
        }
        labelIcon.scale.set(2, 2);
        playerHealth.addChild(labelIcon);

        const TextStyle = new PIXI.TextStyle({
          fontFamily: "Arial",
          fontSize: 24,
          fill: 0x000000,
          align: "center",
        });

        // 现在是第几关
        const text = new PIXI.Text("stage 1", TextStyle);
        text.position.set(20, 400);

        this.panelContainer.addChild(text);
        this.panelContainer.addChild(badTankLift);
        this.panelContainer.addChild(playerHealth);

        this.application.stage.addChild(this.panelContainer);
      };

      TankWar.prototype.createMap = function (id) {
        this.mapContainer = new PIXI.Container();
        this.mapContainer.position.set(14,10);
        if(this.currentStage !=0){
          const settingWallAttribute = (sprite, x, y) => {
            this.settingSpriteAttribute(sprite,  x * 16,y * 16);
            return sprite;
          }

          const currentStageRow = stage[`stage${this.currentStage}`];
          for(let row =0;row<currentStageRow.length;row++){
            const currentStageColumn = stage[`stage${this.currentStage}`][row];
            for(let col = 0;col<currentStageColumn.length;col++){
              if(currentStageColumn[col] === 1) {
                  const wall = new PIXI.Sprite(id.textures['map-dixing-qiang.png']);
                  console.log(col * 16,row * 16, col, row);
                  settingWallAttribute(wall,col,row);
                  this.mapContainer.addChild(wall);
              }
              if(currentStageColumn[col] === 2){
                  const grass = new PIXI.Sprite(id.textures['map-dixing-cao.png']);
                  settingWallAttribute(wall,col,row);
                  this.mapContainer.addChild(wall);
              }
              if(currentStageColumn[col] === 3){
                  const wall = new PIXI.Sprite(id.textures['map-dixing-gang.png']);
                  settingWallAttribute(wall,col,row);
                  this.mapContainer.addChild(wall);
              }
              if(currentStageColumn[col] === 4){
                  const river = new PIXI.Sprite(id.textures['map-dixing-heliu.png']);
                  settingWallAttribute(wall,col,row);
                  this.mapContainer.addChild(wall);
              }
            }
          }
        }
        console.log(this.mapContainer);
        this.application.stage.addChild(this.mapContainer);
      }

      TankWar.prototype.materials = function () {
        const { materials } = constants.texture;
        const id = this.loader.resources.spaceship.spritesheet;
        this.zhuangbeiContainer = new PIXI.Container();
        Object.keys(materials).map((item, i) => {
          const zhuangbei = new PIXI.Sprite(id.textures[materials[item]]);
          zhuangbei.visible = false;
          zhuangbei.position.set(80 * (i + 1), 40 * (i + 1));
          zhuangbei.name = materials[item];
          zhuangbei.anchor.set(0.5, 0.5);
          zhuangbei.scale.set(2, 2);
          this.zhuangbeiContainer.addChild(zhuangbei);
        });
        this.application.stage.addChild(this.zhuangbeiContainer);
      };

      const tankWar = new TankWar({
        width: 570,
        height: 460,
        element: "box",
      });

      
    </script>
  </body>
</html>
