<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tankedazhan</title>
    <style></style>
  </head>

  <body>
    <div id="box"></div>
    <script src="https://pixijs.download/release/pixi.js"></script>
    <script>
      // const level = {
      //   level1:[
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //     [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      //   ]
      // }
      const materials = {
        wall:1,
        grass:2,
        steel:3,
        river:4,
      }
      const constants = {
        INIT_TANK_DOWN: "init-tank-down",
        INIT_TANK_RIGHT: "init-tank-right",
        INIT_TANK_LEFT: "init-tank-left",
        INIT_TANK_UP: "init-tank-up",
        LEVEL2_TANK_DOWN: "level2-tank-down",
        LEVEL2_TANK_UP: "level2-tank-up",
        LEVEL2_TANK_LEFT: "level2-tank-left",
        LEVEL2_TANK_RIGHT: "level2-tank-right",
        LEVEL3_TANK_DOWN: "level3-tank-down",
        LEVEL3_TANK_UP: "level3-tank-up",
        LEVEL3_TANK_LEFT: "level3-tank-left",
        LEVEL3_TANK_RIGHT: "level3-tank-right",
        LEVEL4_TANK_DOWN: "level4-tank-down",
        LEVEL4_TANK_UP: "level4-tank-up",
        LEVEL4_TANK_LEFT: "level4-tank-left",
        LEVEL4_TANK_RIGHT: "level4-tank-right",
        BOOM:'baozha',
      };

      const scale = {
        X: 2,
        Y: 2,
      };

      const defaultSpeed = {
        vx: 0,
        vy: 0,
      };

      function hitTestRectangle(r1, r2) {
        let hit, combinedHalfWidths, combinedHalfHeights, vx, vy;

        hit = false;
        r1.centerX = r1.x + r1.width / 2;
        r1.centerY = r1.y + r1.height / 2;
        r2.centerX = r2.x + r2.width / 2;
        r2.centerY = r2.y + r2.height / 2;

        r1.halfWidth = r1.width / 2;
        r1.halfHeight = r1.height / 2;
        r2.halfWidth = r2.width / 2;
        r2.halfHeight = r2.height / 2;

        vx = r1.centerX - r2.centerX;
        vy = r1.centerY - r2.centerY;

        combinedHalfWidths = r1.halfWidth + r2.halfWidth;
        combinedHalfHeights = r1.halfHeight + r2.halfHeight;

        if (Math.abs(vx) < combinedHalfWidths) {
          if (Math.abs(vy) < combinedHalfHeights) {
            hit = true;
          } else {
            hit = false;
          }
        } else {
          hit = false;
        }

        return hit;
      }

      function keyboard(value) {
        let key = {};
        key.value = value;
        key.isDown = false;
        key.isUp = true;
        key.press = undefined;
        key.release = undefined;
        //The `downHandler`
        key.downHandler = (event) => {
          if (event.key === key.value) {
            if (key.isUp && key.press) key.press();
            key.isDown = true;
            key.isUp = false;
            event.preventDefault();
          }
        };

        //The `upHandler`
        key.upHandler = (event) => {
          if (event.key === key.value) {
            if (key.isDown && key.release) key.release();
            key.isDown = false;
            key.isUp = true;
            event.preventDefault();
          }
        };

        //Attach event listeners
        const downListener = key.downHandler.bind(key);
        const upListener = key.upHandler.bind(key);

        window.addEventListener("keydown", downListener, false);
        window.addEventListener("keyup", upListener, false);

        // Detach event listeners
        key.unsubscribe = () => {
          window.removeEventListener("keydown", downListener);
          window.removeEventListener("keyup", upListener);
        };

        return key;
      }

      function TankWar({ width, height, element }) {
        this.width = width;
        this.height = height;
        this.element = element;
        this.loader = null;
        this.player = null;
        this.status = {
          init: 0,
          padding: 1,
          paddingEnd: 2,
        };
        this.direction = {
          upIsDown: false,
          leftIsDown: true,
          downIsDown: true,
          rightIsDown: true,
        };
        this.life = 1;
        this.application = null;
        this.gun = null;
        this.start = true;
        this.wallArr = null;
        this.init();
      }

      TankWar.prototype.init = function () {
        const { width, height, element } = this;

        this.application = new PIXI.Application({ width, height });
        const dom = document.getElementById(element);
        dom.appendChild(this.application.view);
        this.render();
      };

      TankWar.prototype.play = function (delta) {
        const { gun, wallArr , removeGun} = this;
        const { children } = gun;
        const { leftWall, rightWall, topWall, bottomWall } = wallArr;
        if(children.length !==0) {
          const getGun = gun.getChildAt(0);
          getGun.x +=getGun.vx;
          getGun.y +=getGun.vy;
          if(hitTestRectangle(getGun,leftWall)){
            console.log("leftWall")
           
            removeGun.apply(this, gun);
          }
          if(hitTestRectangle(getGun,rightWall)){
            console.log("rightWall")
            removeGun.apply(this, gun);
          }
          if(hitTestRectangle(getGun,topWall)){
            console.log("topWall")
            removeGun.apply(this, gun);
          }
          if(hitTestRectangle(getGun,bottomWall)){
            console.log("bottomWall")
            removeGun.apply(this, gun);
          }
        };
        this.player.x += this.player.vx;
        this.player.y += this.player.vy;
        
      };

      TankWar.prototype.tankDirection = function (dir) {
        const playerDir = this.player.children;
        for (let i = 0; i < playerDir.length; i++) {
          if (playerDir[i].name === dir) {
            playerDir[i].visible = true;
          } else {
            playerDir[i].visible = false;
          }
        }
      };

      TankWar.prototype.handle = function () {
        let left = keyboard("ArrowLeft"),
          up = keyboard("ArrowUp"),
          right = keyboard("ArrowRight"),
          down = keyboard("ArrowDown");
        keyz = keyboard("z");

        keyz.press = () => {
          this.fire();
        };

        keyz.release = () => {
          // console.log("reslease");
        };

        left.press = () => {
          this.player.vx = -1;
          this.player.vy = 0;
          this.tankDirection(constants.INIT_TANK_LEFT);
        };

        left.release = () => {
          if (!right.isDown && this.player.vy === 0) {
            this.player.vx = 0;
            this.direction = {
              upIsDown: true,
              leftIsDown: true,
              rightIsDown: right.isDown,
              downIsDown: true,
            };
          }
        };

        up.press = () => {
          this.player.vy = -1;
          this.player.vx = 0;
          this.tankDirection(constants.INIT_TANK_UP);
        };
        up.release = () => {
          if (!down.isDown && this.player.vx === 0) {
            this.player.vy = 0;
            this.direction = {
              upIsDown: true,
              leftIsDown: true,
              rightIsDown: true,
              downIsDown: down.isDown,
            };
          }
        };

        right.press = () => {
          this.player.vx = 1;
          this.player.vy = 0;
          this.tankDirection(constants.INIT_TANK_RIGHT);
        };
        right.release = () => {
          if (!left.isDown && this.player.vy === 0) {
            this.player.vx = 0;
            this.direction = {
              upIsDown: true,
              leftIsDown: left.isDown,
              rightIsDown: true,
              downIsDown: true,
            };
          }
        };

        down.press = () => {
          this.player.vy = 1;
          this.player.vx = 0;
          this.tankDirection(constants.INIT_TANK_DOWN);
        };
        down.release = () => {
          if (!up.isDown && this.player.vx === 0) {
            this.player.vy = 0;
            this.direction = {
              upIsDown: up.isDown,
              leftIsDown: true,
              rightIsDown: true,
              downIsDown: true,
            };
          }
        };
      };

      TankWar.prototype.render = function () {
        const { INIT_TANK_DOWN } = constants;
        const { vx, vy } = defaultSpeed;
        const that = this;
        that.loader = new PIXI.Loader();
        that.loader
          .add("tank", "./tankedazhan.png")
          .add("spaceship", "tankedazhan.json");
        that.loader.load((loader, resource) => {
          const id = resource.spaceship.spritesheet.animations;
          this.player = new PIXI.Container();
          Object.keys(constants).forEach((item, index) => {
            let tankDir = new PIXI.AnimatedSprite(id[constants[item]]);
            tankDir.animationSpeed = 0.2;
            tankDir.play();
            tankDir.visible =
              constants[item] === constants.INIT_TANK_DOWN;
            tankDir.name = constants[item];
            this.player.addChild(tankDir);
          });
          this.player.life = this.life;
          this.player.scale.x = scale.X;
          this.player.scale.y = scale.Y;
          this.player.vx = vx;
          this.player.vy = vy;
          this.player.x = 30;
          this.player.y = 500;

          this.application.stage.addChild(this.player);
          this.application.ticker.add(function (delta) {
            that.play(delta);
          });
          this.gun = new PIXI.Container();
          this.application.stage.addChild(this.gun);
          this.handle();
          this.createAirWall();
           
        });
      };

      TankWar.prototype.createAirWall = function () {
        const container = new PIXI.Container();
        this.application.stage.addChild(container);

        const leftWall = new PIXI.Graphics();
        leftWall.beginFill(0xde3249);
        leftWall.drawRect(0, 0, 5, this.height);
        leftWall.position.set(0, 0);
        leftWall.endFill();
        container.addChild(leftWall);

        const rightWall = new PIXI.Graphics();
        rightWall.beginFill(0xde3249);
        rightWall.drawRect(0, 0, 5, this.height);
        rightWall.endFill();
        rightWall.position.set((this.width) - 5, 0);
        container.addChild(rightWall);

        const topWall = new PIXI.Graphics();
        topWall.beginFill(0xde3249);
        topWall.drawRect(0, 0, this.width, 5);
        topWall.position.set(0, 0);
        topWall.endFill();
        container.addChild(topWall);
  
        const bottomWall = new PIXI.Graphics();
        bottomWall.beginFill(0xde3249);
        bottomWall.drawRect(0, 0, this.width, 5);
        bottomWall.position.set(0, (this.height) - 5);
        bottomWall.endFill();

        this.wallArr = {
          wall: container,
          leftWall: leftWall,
          rightWall: rightWall,
          topWall: topWall,
          bottomWall: bottomWall,
        };

        container.addChild(bottomWall);
      };

      TankWar.prototype.fire = function () {
        const { upIsDown, leftIsDown, downIsDown, rightIsDown } =
          this.direction;
        const { vx, vy } = defaultSpeed;
        const {x,y,width,height} = this.player;
        const gunX = x+width;
        const gunY = y+height;
        // console.log(x,width,y,height);
        // console.log(gunX,gunY)
        if ((this.gun.children.length === 0 && this.gun.children < 2) ) {
          const graphics = new PIXI.Graphics();
          graphics.beginFill(0xffffff);
          graphics.drawRect(0, 0, 3, 3);
          graphics.endFill();
          this.gun.addChild(graphics);

          if (!upIsDown) {
            console.log(graphics);
            graphics.vx = 0;
            graphics.vy = 4;
            graphics.x = gunX - width/2 - 2;
            graphics.y = gunY;
          }
          else if (!leftIsDown){
            graphics.vx = 4;
            graphics.vy = 0;
            graphics.x = gunX;
            graphics.y = gunY - height/2 - 2;
          }
          else if(!rightIsDown){
            graphics.vx = -4;
            graphics.vy = 0;
            graphics.x = gunX - width - 2;
            graphics.y = gunY - height/2 - 2;
          }
          else if(!downIsDown){
            graphics.vx = 0;
            graphics.vy = -4;
            graphics.x = gunX - width/2 - 3;
            graphics.y = gunY - height - 2;
          }
        }
      };

      TankWar.prototype.removeGun = function () {
        const {gun} = this;
        const getGun = gun.getChildAt(0);
        gun.removeChildren();
        this.boom(getGun.x,getGun.y)
      }
      
      TankWar.prototype.boom = function (x,y) {
        const {BOOM} = constants;
        const id = this.loader.resources.spaceship.spritesheet.animations;
        console.log(id[BOOM],BOOM)
        const boom = new PIXI.AnimatedSprite(id[BOOM]);
        boom.animationSpeed = 0.2;
        boom.play();
        boom.name= BOOM
        boom.loop = false;
        boom.onComplete = () => {
          const getBOOM = this.application.stage.getChildByName(BOOM);
          this.application.stage.removeChild(getBOOM);         
        }
        boom.scale.x = 2;
        boom.scale.y = 2;
        boom.anchor.set(0.5,0.5);
        console.log(x,y)
        boom.x = x;
        boom.y = y;
        this.application.stage.addChild(boom);
      }

      TankWar.prototype.createMap = function () {

      };

      TankWar.prototype.materials = function () {

      };

      const tankWar = new TankWar({
        width: 880,
        height: 800,
        element: "box",
      });
    </script>
  </body>
</html>
